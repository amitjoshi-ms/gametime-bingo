name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to rollback to (e.g., v1.0.0)'
        required: true
        type: string
      confirm:
        description: 'Type "rollback" to confirm'
        required: true
        type: string

permissions:
  contents: write

jobs:
  rollback:
    name: Rollback to Previous Release
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'rollback'
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate target tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          # Check if tag exists
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG does not exist"
            exit 1
          fi
          
          echo "Target tag $TAG exists"
          
          # Show what will be rolled back
          echo "### Rollback Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target Commit:** \`$(git rev-parse --short $TAG)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Release Branch:** \`$(git rev-parse --short release)\`" >> $GITHUB_STEP_SUMMARY

      - name: Unlock release branch
        run: |
          # Check if branch protection exists using exit code first
          set +e
          RESPONSE=$(gh api repos/${{ github.repository }}/branches/release/protection 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Removing branch protection..."
            gh api repos/${{ github.repository }}/branches/release/protection -X DELETE
            echo "Branch protection removed."
          elif echo "$RESPONSE" | grep -q "404"; then
            echo "No branch protection found, skipping unlock."
          else
            echo "::error::Failed to check branch protection: $RESPONSE"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Perform rollback
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          # Checkout release branch and reset to target tag
          git checkout release
          git reset --hard "$TAG"
          git push --force origin release
          
          echo "Rolled back release branch to $TAG"

      - name: Create rollback tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          ROLLBACK_TAG="${TAG}-rollback-$(date +%Y%m%d-%H%M%S)"
          
          git tag "$ROLLBACK_TAG" -m "Rollback to $TAG"
          git push origin "$ROLLBACK_TAG"
          
          echo "ROLLBACK_TAG=$ROLLBACK_TAG" >> $GITHUB_ENV

      - name: Lock release branch
        run: |
          echo "Applying branch protection..."
          gh api repos/${{ github.repository }}/branches/release/protection \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            -f lock_branch=true \
            -f required_status_checks=null \
            -f enforce_admins=true \
            -f required_pull_request_reviews=null \
            -f restrictions=null \
            -f allow_force_pushes=false \
            -f allow_deletions=false
          
          sleep 2
          set +e
          PROTECTION=$(gh api repos/${{ github.repository }}/branches/release/protection 2>&1)
          API_EXIT=$?
          set -e
          
          if [ $API_EXIT -ne 0 ]; then
            echo "::error::Failed to fetch branch protection: $PROTECTION"
            exit 1
          fi
          
          if echo "$PROTECTION" | jq -e '.lock_branch == true' > /dev/null 2>&1; then
            echo "Branch protection verified (lock_branch=true)."
          else
            echo "::error::Branch protection applied but lock_branch is not true!"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ⏮️ Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback tag:** \`${{ env.ROLLBACK_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Cloudflare Pages will automatically redeploy from the \`release\` branch" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor the deployment at Cloudflare Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify production site after deployment completes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Important" >> $GITHUB_STEP_SUMMARY
          echo "If the issue was in code, create a fix PR and merge to \`main\` before next release" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup - Re-lock branch on failure
        if: failure()
        run: |
          echo "::warning::Workflow failed, attempting to re-lock release branch..."
          gh api repos/${{ github.repository }}/branches/release/protection \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            -f lock_branch=true \
            -f required_status_checks=null \
            -f enforce_admins=true \
            -f required_pull_request_reviews=null \
            -f restrictions=null \
            -f allow_force_pushes=false \
            -f allow_deletions=false \
            && echo "Branch re-locked successfully." \
            || echo "::error::CRITICAL: Failed to re-lock branch! Manual intervention required."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify-rollback:
    name: Verify Rollback
    runs-on: ubuntu-latest
    needs: rollback
    steps:
      - name: Wait for Cloudflare deployment
        run: |
          echo "Waiting 60 seconds for Cloudflare Pages to redeploy..."
          sleep 60

      - name: Verify production site
        run: |
          # Use secret PRODUCTION_URL if set, otherwise fail with helpful message
          if [ -z "${{ secrets.PRODUCTION_URL }}" ]; then
            echo "::error::PRODUCTION_URL secret is not configured"
            echo "::error::Please set PRODUCTION_URL in repository secrets"
            echo "::error::Example: https://your-site.pages.dev"
            exit 1
          fi
          
          PROD_URL="${{ secrets.PRODUCTION_URL }}"
          
          echo "Verifying production site at: $PROD_URL"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Production site is accessible after rollback (HTTP $HTTP_CODE)"
          else
            echo "::error::❌ Production site returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Verification summary
        if: success()
        run: |
          echo "## ✅ Rollback Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production site is accessible after rollback." >> $GITHUB_STEP_SUMMARY
